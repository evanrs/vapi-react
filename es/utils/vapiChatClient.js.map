{"version":3,"file":"vapiChatClient.js","sources":["../../src/utils/vapiChatClient.ts"],"sourcesContent":["import { fetchEventSource } from '@microsoft/fetch-event-source';\n\nexport interface AssistantOverrides {\n  variableValues?: {\n    [key: string]: string;\n  };\n}\n\nexport interface VapiChatMessage {\n  input: string | Array<{ role: string; content: string }>;\n  assistantId: string;\n  assistantOverrides?: AssistantOverrides;\n  sessionId?: string;\n  stream?: boolean;\n  sessionEnd?: boolean;\n}\n\nexport interface VapiChatStreamChunk {\n  id?: string;\n  path?: string;\n  delta?: string;\n  sessionId?: string;\n  output?: string;\n  [key: string]: any;\n}\n\nexport interface VapiChatClientOptions {\n  apiUrl?: string;\n  publicKey: string;\n}\n\nexport type StreamCallback = (chunk: VapiChatStreamChunk) => void;\nexport type ErrorCallback = (error: Error) => void;\nexport type CompleteCallback = () => void;\n\n// Custom error classes for retry logic\nclass RetriableError extends Error {}\nclass FatalError extends Error {}\n\nexport class VapiChatClient {\n  private apiUrl: string;\n  private publicKey: string;\n  private abortController: AbortController | null = null;\n\n  constructor(options: VapiChatClientOptions) {\n    this.publicKey = options.publicKey;\n    this.apiUrl = options.apiUrl || 'https://api.vapi.ai';\n  }\n\n  async streamChat(\n    message: VapiChatMessage,\n    onChunk: StreamCallback,\n    onError?: ErrorCallback,\n    onComplete?: CompleteCallback\n  ): Promise<() => void> {\n    // Cancel any existing stream\n    this.abort();\n\n    // Create new abort controller\n    this.abortController = new AbortController();\n\n    try {\n      await fetchEventSource(`${this.apiUrl}/chat/web`, {\n        method: 'POST',\n        headers: {\n          Authorization: `Bearer ${this.publicKey}`,\n          'Content-Type': 'application/json',\n          'X-Client-ID': 'vapi-widget',\n        },\n        body: JSON.stringify({\n          ...message,\n          stream: true,\n        }),\n        signal: this.abortController.signal,\n\n        // Event handlers\n        async onopen(response) {\n          if (\n            response.ok &&\n            response.headers.get('content-type')?.includes('text/event-stream')\n          ) {\n            return; // everything's good\n          } else if (\n            response.status >= 400 &&\n            response.status < 500 &&\n            response.status !== 429\n          ) {\n            // Client errors are non-retriable\n            throw new FatalError(`HTTP error! status: ${response.status}`);\n          } else {\n            throw new RetriableError(`HTTP error! status: ${response.status}`);\n          }\n        },\n\n        onmessage(event) {\n          // Skip the [DONE] message\n          if (event.data === '[DONE]') {\n            return;\n          }\n\n          try {\n            const chunk = JSON.parse(event.data) as VapiChatStreamChunk;\n            // Only emit chunks that have relevant content\n            if (\n              chunk.delta !== undefined ||\n              chunk.output !== undefined ||\n              chunk.path !== undefined\n            ) {\n              onChunk(chunk);\n            }\n          } catch (error) {\n            console.warn(`Failed to parse SSE data: ${event.data}`);\n          }\n        },\n\n        onclose() {\n          // Stream closed normally\n          onComplete?.();\n        },\n\n        onerror(err) {\n          if (err instanceof FatalError) {\n            onError?.(err);\n            throw err; // Stop the operation\n          } else if (err instanceof Error && err.name === 'AbortError') {\n            // Stream was intentionally aborted\n            onComplete?.();\n            throw err; // Stop the operation\n          } else {\n            // Retriable error - return nothing to retry\n            // You can also return a retry interval in milliseconds\n            console.warn('Retriable error occurred, retrying...', err);\n          }\n        },\n      });\n    } catch (error) {\n      // Handle any errors that weren't handled in onerror\n      if (error instanceof Error && error.name !== 'AbortError') {\n        onError?.(error);\n      }\n    }\n\n    // Return abort function\n    return () => this.abort();\n  }\n\n  abort() {\n    if (this.abortController) {\n      this.abortController.abort();\n      this.abortController = null;\n    }\n  }\n}\n\nexport function extractContentFromPath(\n  chunk: VapiChatStreamChunk\n): string | null {\n  // Check if this is a content chunk with delta and path\n  if (chunk.delta && chunk.path === 'chat.output[0].content') {\n    return chunk.delta;\n  }\n  // Also check for direct output field\n  if (chunk.output !== undefined) {\n    return chunk.output;\n  }\n  return null;\n}\n"],"names":["RetriableError","FatalError","VapiChatClient","options","message","onChunk","onError","onComplete","fetchEventSource","response","event","chunk","err","error","extractContentFromPath"],"mappings":";AAoCA,MAAMA,UAAuB,MAAM;AAAC;AACpC,MAAMC,UAAmB,MAAM;AAAC;AAEzB,MAAMC,EAAe;AAAA,EAClB;AAAA,EACA;AAAA,EACA,kBAA0C;AAAA,EAElD,YAAYC,GAAgC;AAC1C,SAAK,YAAYA,EAAQ,WACzB,KAAK,SAASA,EAAQ,UAAU;AAAA,EAClC;AAAA,EAEA,MAAM,WACJC,GACAC,GACAC,GACAC,GACqB;AAErB,SAAK,MAAA,GAGL,KAAK,kBAAkB,IAAI,gBAAA;AAE3B,QAAI;AACF,YAAMC,EAAiB,GAAG,KAAK,MAAM,aAAa;AAAA,QAChD,QAAQ;AAAA,QACR,SAAS;AAAA,UACP,eAAe,UAAU,KAAK,SAAS;AAAA,UACvC,gBAAgB;AAAA,UAChB,eAAe;AAAA,QAAA;AAAA,QAEjB,MAAM,KAAK,UAAU;AAAA,UACnB,GAAGJ;AAAA,UACH,QAAQ;AAAA,QAAA,CACT;AAAA,QACD,QAAQ,KAAK,gBAAgB;AAAA;AAAA,QAG7B,MAAM,OAAOK,GAAU;AACrB,cACE,EAAAA,EAAS,MACTA,EAAS,QAAQ,IAAI,cAAc,GAAG,SAAS,mBAAmB;AAGpE,kBACEA,EAAS,UAAU,OACnBA,EAAS,SAAS,OAClBA,EAAS,WAAW,MAGd,IAAIR,EAAW,uBAAuBQ,EAAS,MAAM,EAAE,IAEvD,IAAIT,EAAe,uBAAuBS,EAAS,MAAM,EAAE;AAAA,QAErE;AAAA,QAEA,UAAUC,GAAO;AAEf,cAAIA,EAAM,SAAS;AAInB,gBAAI;AACF,oBAAMC,IAAQ,KAAK,MAAMD,EAAM,IAAI;AAEnC,eACEC,EAAM,UAAU,UAChBA,EAAM,WAAW,UACjBA,EAAM,SAAS,WAEfN,EAAQM,CAAK;AAAA,YAEjB,QAAgB;AACd,sBAAQ,KAAK,6BAA6BD,EAAM,IAAI,EAAE;AAAA,YACxD;AAAA,QACF;AAAA,QAEA,UAAU;AAER,UAAAH,IAAA;AAAA,QACF;AAAA,QAEA,QAAQK,GAAK;AACX,cAAIA,aAAeX;AACjB,kBAAAK,IAAUM,CAAG,GACPA;AACR,cAAWA,aAAe,SAASA,EAAI,SAAS;AAE9C,kBAAAL,IAAA,GACMK;AAIN,kBAAQ,KAAK,yCAAyCA,CAAG;AAAA,QAE7D;AAAA,MAAA,CACD;AAAA,IACH,SAASC,GAAO;AAEd,MAAIA,aAAiB,SAASA,EAAM,SAAS,gBAC3CP,IAAUO,CAAK;AAAA,IAEnB;AAGA,WAAO,MAAM,KAAK,MAAA;AAAA,EACpB;AAAA,EAEA,QAAQ;AACN,IAAI,KAAK,oBACP,KAAK,gBAAgB,MAAA,GACrB,KAAK,kBAAkB;AAAA,EAE3B;AACF;AAEO,SAASC,EACdH,GACe;AAEf,SAAIA,EAAM,SAASA,EAAM,SAAS,2BACzBA,EAAM,QAGXA,EAAM,WAAW,SACZA,EAAM,SAER;AACT;"}